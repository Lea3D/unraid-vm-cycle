Menu="Utilities"
Icon="vm-cycle.png"
Title="vm-cycle"
---
<?php
$vmcyclevmsetup = parse_ini_file("/boot/config/plugins/vm-cycle/vmcyclesettings",true);
$lv = new Libvirt('qemu:///system');
$vms = $lv->get_domains();
$gpuList = getValidGPUDevices();
function getIcon($res, $uuid) {
  global $lv;
  $icon = $lv->domain_get_icon_url($res);
  if (!$icon || !file_exists("/usr/local/emhttp/" . ltrim($icon, '/'))) {
    $icon = "/plugins/dynamix.vm.manager/templates/images/question.png";
  }
  return $icon;
}
function getPciNames($config) {
  global $gpuList;
  $names = [];
  if (!empty($config['gpu'])) {
    foreach ($config['gpu'] as $gpu) {
      foreach ($gpuList as $known) {
        if ($gpu['id'] == $known['id']) $names[] = $known['name'];
      }
    }
  }
  if (!empty($config['pci'])) {
    foreach ($config['pci'] as $pci) {
      $names[] = $pci['id'];
    }
  }
  return implode("<br>", $names);
}
function getUsbNames($config) {
  if (!empty($config['usb'])) {
    return implode("<br>", array_column($config['usb'], 'name'));
  }
  return '';
}
?>

<div style="display: flex; justify-content: center;">
  <table class="tablesorter" style="width: auto; max-width: 1000px; margin: 0 auto;">
    <thead>
      <tr>
        <th>Icon</th>
        <th>VM Name</th>
        <th>PCI Devices</th>
        <th>USB Devices</th>
      </tr>
    </thead>
    <tbody>
<?php foreach ($vms as $vm): ?>
<?php
  $res = $lv->get_domain_by_name($vm);
  $uuid = $lv->domain_get_uuid($res);
  $config = domain_to_config($uuid);
  $icon = getIcon($res, $uuid);
  $pci = getPciNames($config);
  $usb = getUsbNames($config);
?>
      <tr>
        <td><img src="<?= $icon ?>" class="img" style="height: 32px;"></td>
        <td><?= htmlspecialchars($vm) ?></td>
        <td><?= $pci ?></td>
        <td><?= $usb ?></td>
      </tr>
<?php endforeach; ?>
    </tbody>
  </table>
</div>
