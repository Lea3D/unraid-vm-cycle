Menu="Utilities"
Icon="vm-cycle.png"
Title="vm-cycle"
---
<?php
$vmcyclevmsetup            = parse_ini_file("/boot/config/plugins/vm-cycle/vmcyclesettings",true);
//VM Setup
$vmcyclevmsetup_vm1        = isset($vmcyclevmsetup['VM1']) ? $vmcyclevmsetup['VM1'] : "";
$vmcyclevmsetup_vm2        = isset($vmcyclevmsetup['VM2']) ? $vmcyclevmsetup['VM2'] : "";
//VM Docker Setup
$vmcyclevmsetup_vmdocker        = isset($vmcyclevmsetup['VMD']) ? $vmcyclevmsetup['VMD'] : "";
$vmcyclevmsetup_docker        = isset($vmcyclevmsetup['DOCKERS']) ? $vmcyclevmsetup['DOCKERS'] : "";

function get_vm_list($filter = "all") {
    $vms = [];
    $cmd = "/usr/local/emhttp/plugins/vm-cycle/scripts/getvms.sh " . escapeshellarg($filter);
    $output = shell_exec($cmd);
    foreach (explode("\n", trim($output)) as $line) {
        if (!empty($line)) {
            $vms[] = htmlspecialchars($line, ENT_QUOTES);
        }
    }
    return $vms;
}

$filter = isset($_POST['vmfilter']) ? $_POST['vmfilter'] : 'all';
$available_vms = get_vm_list($filter);
?>

<script>
    function send(command) {
        if(command == "start"){
            document.getElementById("command").value = "/usr/local/emhttp/plugins/vm-cycle/scripts/start";
        } else if( command == "startdocker" ){
            document.getElementById("command").value = "/usr/local/emhttp/plugins/vm-cycle/scripts/startdocker";
        }
        document.getElementById("form").submit();
    }
</script>

<form method="POST">
  Filter:
  : <select name="vmfilter" class="narrow" onchange="this.form.submit()">
      <option value="all" <?= $filter == 'all' ? 'selected' : '' ?>>All VMs</option>
      <option value="running" <?= $filter == 'running' ? 'selected' : '' ?>>Running only</option>
      <option value="stopped" <?= $filter == 'stopped' ? 'selected' : '' ?>>Stopped only</option>
      <option value="paused" <?= $filter == 'paused' ? 'selected' : '' ?>>Paused only</option>
      <option value="pci" <?= $filter == 'pci' ? 'selected' : '' ?>>With PCI passthrough</option>
      <option value="usb" <?= $filter == 'usb' ? 'selected' : '' ?>>With USB passthrough</option>
    </select>
</form>

<div style="display: flex; justify-content: center;">
  <table style="border-collapse: collapse; width: auto; max-width: 800px; margin: 0 auto;">
  <thead>
    <tr>
      <th style="text-align: center; padding: 0.5em;">Icon</th>
      <th style="text-align: left; padding: 0.5em 1em;">VM Name</th>
      <th style="text-align: center; padding: 0.5em;">Status</th>
      <th style="text-align: center; padding: 0.5em;">PCI</th>
      <th style="text-align: center; padding: 0.5em;">USB</th>
    </tr>
  </thead>
  <tbody>
<?php
foreach ($available_vms as $vm) {
    $xml = shell_exec("virsh dumpxml " . escapeshellarg($vm));
    $icon = '';
    if (preg_match('/<vmtemplate[^>]*icon="([^"]+)"/', $xml, $matches)) {
        $icon_name = basename($matches[1]);
        $icon_path = "/usr/local/emhttp/plugins/dynamix.vm.manager/templates/images/" . $icon_name;
        if (file_exists($icon_path)) {
            $icon = '<img src="' . $icon_path . '" alt="icon" style="height: 24px;">';
        } else {
            $icon = '<span style="display:inline-block; width:24px;"></span>';
        }
    } else {
        $icon = '<span style="display:inline-block; width:24px;"></span>';
    }

    $vmstate = trim(shell_exec("virsh domstate " . escapeshellarg($vm)));
    $has_pci = strpos($xml, "<hostdev mode='subsystem' type='pci'") !== false;
    $has_usb = strpos($xml, "<hostdev mode='subsystem' type='usb'") !== false;

    switch ($vmstate) {
        case 'running':
            $state_icon = '<i class="fa fa-play green-text"></i>';
            break;
        case 'paused':
            $state_icon = '<i class="fa fa-square paused orange-text"></i>';
            break;
        default:
            $state_icon = '<i class="fa fa-square stopped red-text"></i>';
    }

    $pci_icon = $has_pci ? '<i class="icon-hardware PanelIcon"></i>' : '<span style="display:inline-block; width:16px;"></span>';
    $usb_icon = $has_usb ? '<i class="icon-usb"></i>' : '<span style="display:inline-block; width:16px;"></span>';

    echo "    <tr>\n";
    echo '      <td style="text-align: center; padding: 0.5em;">' . $icon . '</td>' . "\n";
    echo '      <td style="padding: 0.5em 1em;">' . $vm . '</td>' . "\n";
    echo '      <td style="text-align: center; padding: 0.5em;">' . $state_icon . '</td>' . "\n";
    echo '      <td style="text-align: center; padding: 0.5em;">' . $pci_icon . '</td>' . "\n";
    echo '      <td style="text-align: center; padding: 0.5em;">' . $usb_icon . '</td>' . "\n";
    echo "    </tr>\n";
}
?>
  </tbody>
</table></div>

<form markdown="1" id="form" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" id="file" name="#file" value="/boot/config/plugins/vm-cycle/vmcyclesettings" />
<input type="hidden" id="command" name="#command" value="" />

<div class="title"><span class="left"><i class="fa fa-hand-peace-o title"></i>Cycle VM vs VM</span></div>

VM 1:
: <select name="VM1" class="narrow">
    <?php foreach ($available_vms as $vm): ?>
        <option value="<?= $vm ?>" <?= $vm == $vmcyclevmsetup_vm1 ? 'selected' : '' ?>><?= $vm ?></option>
    <?php endforeach; ?>
  </select>
    <blockquote class='inline_help'>
        <p>set your first VM Name here to cycle, sequence doesn't matter</p>
    </blockquote>

VM 2:
: <select name="VM2" class="narrow">
    <?php foreach ($available_vms as $vm): ?>
        <option value="<?= $vm ?>" <?= $vm == $vmcyclevmsetup_vm2 ? 'selected' : '' ?>><?= $vm ?></option>
    <?php endforeach; ?>
  </select>
    <blockquote class='inline_help'>
        <p>set your second VM Name here to cycle, sequence doesn't matter</p>
    </blockquote>

<div style="text-align: center;">
    <input type="button" value="Apply" onClick="send('apply')">
    <input type="button" value="Cycle VMs" onClick="send('start')">
</div>

<div class="title"><span class="left"><i class="fa fa-hand-peace-o title"></i>Cycle VM vs Docker/s</span></div>

VM:
: <input type="text" name="VMD" class="narrow" maxlength="50" value="<?=$vmcyclevmsetup_vmdocker;?>" placeholder="VM Name" >
    <blockquote class='inline_help'>
        <p>set your VM Name here to cycle</p>
		<p>if the VM is running, we stop the VM, start the Dockers, if VM is off, vice versa</p>
    </blockquote>

DOCKER:
: <input type="text" name="DOCKERS" class="narrow" maxlength="50" value="<?=$vmcyclevmsetup_docker;?>" placeholder="DOCKER Name/s" >
    <blockquote class='inline_help'>
        <p>set your Docker Name/s here to cycle, space separated, sequence doesn't matter</p>
    </blockquote>

<div style="text-align: center;">
    <input type="button" value="Apply" onClick="send('apply')">
    <input type="button" value="Cycle VM Docker" onClick="send('startdocker')">
</div>

</form>
